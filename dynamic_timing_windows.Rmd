---
title: "Puberty Dynamic Timing Windows"
author: "Michelle Byrne"
date: "11/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set Working Directory
```{r Set Directory, message=FALSE, warning=FALSE, include=FALSE}
getwd()
#You should set this to the TAG directory on the CAS file server 
workdir='Z:/dsnlab/TAG/' 
```


```{r Load and Clean Data}
library(dplyr)
library(zoo)
# Load Data (Wave 1 and 2) first - see Marjolein's code for how this all got put together
data <- read.csv(file.path(workdir,"projects/W1_W2_pubertal_timing/Timing_allways_withgrade.csv", fsep=""))
```

```{r 6 month Dynamic Timing Windows (DTW) - LD stage}
# for each individual, find the mean of the values from everyone else that is within 1 year age of them (+/- 0.5), then take that person's value and subtract the mean of that value only within the subset. We do this separately by wave to avoid comparing peers across waves.

# Wave 1:
data_w1 <- data[which(data$wave=='1'),]

# First do them for LDstage:
data_w1$max_age <- data_w1$age + 0.5
data_w1$min_age <- data_w1$age - 0.5

for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  # modify dataframe
  temp_data_w1 <- data_w1[-i, ] # -i b/c don't want to compare to themselves
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$ldstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  # then go back to the original loop and subtract the mean of the current vector of values from the original individual's value  
  comp_values <- as.numeric(comp_values)
  data_w1$window_ldstage[i] <- data_w1$ldstage[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_ldstage_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
data_w2 <- data[which(data$wave=='2'),]

# For LDstage:
data_w2$max_age <- data_w2$age + 0.5
data_w2$min_age <- data_w2$age - 0.5

for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  # modify dataframe
  temp_data_w2 <- data_w2[-i, ] # -i b/c don't want to compare to themselves
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$ldstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  # then go back to the original loop and subtract the mean of the current vector of values from the original individual's value  
  comp_values <- as.numeric(comp_values)
  data_w2$window_ldstage[i] <- data_w2$ldstage[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_ldstage_compN[i] <- length(na.omit(comp_values))
}
```

```{r Dynamic Timing Windows - PDS stage}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_pdsstage[i] <- data_w1$pdsstage[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_pdsstage_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_pdsstage[i] <- data_w2$pdsstage[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_pdsstage_compN[i] <- length(na.omit(comp_values))
}
```

```{r 6 mo DTW - ADRENcomp}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$ADRENcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_ADRENcomp[i] <- data_w1$ADRENcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_ADRENcomp_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$ADRENcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_ADRENcomp[i] <- data_w2$ADRENcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_ADRENcomp_compN[i] <- length(na.omit(comp_values))
}
```
        
```{r 6 mo DTW - GONADcomp}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$GONADcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_GONADcomp[i] <- data_w1$GONADcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_GONADcomp_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$GONADcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_GONADcomp[i] <- data_w2$GONADcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_GONADcomp_compN[i] <- length(na.omit(comp_values))
}
```
        
```{r 6 mo DTW - PUBcomp}

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$PUBcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_PUBcomp[i] <- data_w1$PUBcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_PUBcomp_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$PUBcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_PUBcomp[i] <- data_w2$PUBcomp[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_PUBcomp_compN[i] <- length(na.omit(comp_values))
}
```

```{r 6 mo DTW - Parent PDS stage}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$parent_pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_parent_pdsstage[i] <- data_w1$parent_pdsstage[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_parent_pdsstage_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$parent_pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_parent_pdsstage[i] <- data_w2$parent_pdsstage[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_parent_pdsstage_compN[i] <- length(na.omit(comp_values))
}
```
 
```{r 6 mo DTW - DHEA mean}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$DHEAmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_DHEAmean[i] <- data_w1$DHEAmean[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_DHEAmean_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$DHEAmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_DHEAmean[i] <- data_w2$DHEAmean[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_DHEAmean_compN[i] <- length(na.omit(comp_values))
}
``` 
 
```{r 6 mo DTW - TEST mean}

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$TESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_TESTmean[i] <- data_w1$TESTmean[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_TESTmean_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$TESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_TESTmean[i] <- data_w2$TESTmean[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_TESTmean_compN[i] <- length(na.omit(comp_values))
}
```  

```{r 6 mo DTW - EST mean}

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$ESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_ESTmean[i] <- data_w1$ESTmean[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_ESTmean_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$ESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_ESTmean[i] <- data_w2$ESTmean[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_ESTmean_compN[i] <- length(na.omit(comp_values))
}
```      
  
```{r 6 mo DTW - DHEA basal estimate}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$DHEA_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_DHEA_cor[i] <- data_w1$DHEA_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_DHEA_cor_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$DHEA_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_DHEA_cor[i] <- data_w2$DHEA_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_DHEA_cor_compN[i] <- length(na.omit(comp_values))
}
``` 
 
```{r 6 mo DTW - TEST basal estimate}

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$TEST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_TEST_cor[i] <- data_w1$TEST_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_TEST_cor_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$TEST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_TEST_cor[i] <- data_w2$TEST_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_TEST_cor_compN[i] <- length(na.omit(comp_values))
}
```  

```{r 6 mo DTW - EST basal estimate}

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w1$max_age[i]
  curr_min_age <- data_w1$min_age[i]
  
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$age[j] > curr_min_age & temp_data_w1$age[j] < curr_max_age, temp_data_w1$EST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w1$window_EST_cor[i] <- data_w1$EST_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w1$window_EST_cor_compN[i] <- length(na.omit(comp_values))
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  
  curr_max_age <- data_w2$max_age[i]
  curr_min_age <- data_w2$min_age[i]
  
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$age[j] > curr_min_age & temp_data_w2$age[j] < curr_max_age, temp_data_w2$EST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
 
  comp_values <- as.numeric(comp_values)
  data_w2$window_EST_cor[i] <- data_w2$EST_cor[i] - mean(comp_values, na.rm = TRUE)
  data_w2$window_EST_cor_compN[i] <- length(na.omit(comp_values))
}
```      
 

# At the end of this script are the correlations between residual and windows timing measures. At first, we did it only with AGE dynamic timing windows (+/- 6 months). From that, we learned that at Wave 2 - controlling stage for age was not totally the same as comparing stage with +/- 6 month peers, especially for the adrenarcheal measures.

# So now we also do all the window measures again comparing to the same school grade (instead of same age) - grade dynamic timing windows. At the end we will compare all three (age residual, age DTW, grade DTW) - spoiler alert grade windows are no different to age windows.

```{r Grade DTW - LD stage}
# for each individual, find the mean of the values from everyone else that is in the same school grade as them, then take that person's value and subtract the mean of that value only within the subset. We do this separately by wave to avoid comparing peers across waves.

# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  
  curr_grade <- data_w1$grade[i]

  # modify dataframe
  temp_data_w1 <- data_w1[-i, ] # -i b/c don't want to compare to themselves
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$ldstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  # then go back to the original loop and subtract the mean of the current vector of values from the original individual's value  
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_ldstage[i] <- data_w1$ldstage[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  
  # modify dataframe
  temp_data_w2 <- data_w2[-i, ] # -i b/c don't want to compare to themselves
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$ldstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  # then go back to the original loop and subtract the mean of the current vector of values from the original individual's value  
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_ldstage[i] <- data_w2$ldstage[i] - mean(comp_values, na.rm = TRUE)
}
```
```{r Grade DTW - PDS stage}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_pdsstage[i] <- data_w1$pdsstage[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_pdsstage[i] <- data_w2$pdsstage[i] - mean(comp_values, na.rm = TRUE)
}
```

```{r Grade DTW - ADRENcomp}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$ADRENcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_ADRENcomp[i] <- data_w1$ADRENcomp[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$ADRENcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_ADRENcomp[i] <- data_w2$ADRENcomp[i] - mean(comp_values, na.rm = TRUE)
}
```
        
```{r Grade DTW - GONADcomp}
# Wave 1:
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$GONADcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_GONADcomp[i] <- data_w1$GONADcomp[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$GONADcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_GONADcomp[i] <- data_w2$GONADcomp[i] - mean(comp_values, na.rm = TRUE)
}
```
        
```{r Grade DTW - PUBcomp}

# Wave 1:
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$PUBcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_PUBcomp[i] <- data_w1$PUBcomp[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$PUBcomp[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_PUBcomp[i] <- data_w2$PUBcomp[i] - mean(comp_values, na.rm = TRUE)
}
```

```{r Grade DTW - Parent PDS stage}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$parent_pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_parent_pdsstage[i] <- data_w1$parent_pdsstage[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$parent_pdsstage[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_parent_pdsstage[i] <- data_w2$parent_pdsstage[i] - mean(comp_values, na.rm = TRUE)
}
```
 
```{r Grade DTW - DHEA mean}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$DHEAmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_DHEAmean[i] <- data_w1$DHEAmean[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$DHEAmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_DHEAmean[i] <- data_w2$DHEAmean[i] - mean(comp_values, na.rm = TRUE)
}
``` 
 
```{r Grade DTW - TEST mean}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$TESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_TESTmean[i] <- data_w1$TESTmean[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$TESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_TESTmean[i] <- data_w2$TESTmean[i] - mean(comp_values, na.rm = TRUE)
}
```  

```{r Grade DTW - EST mean}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$ESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_ESTmean[i] <- data_w1$ESTmean[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$ESTmean[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_ESTmean[i] <- data_w2$ESTmean[i] - mean(comp_values, na.rm = TRUE)
}
```      
  
```{r Grade DTW - DHEA basal estimate}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$DHEA_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_DHEA_cor[i] <- data_w1$DHEA_cor[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$DHEA_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_DHEA_cor[i] <- data_w2$DHEA_cor[i] - mean(comp_values, na.rm = TRUE)
}
``` 
 
```{r Grade DTW - TEST basal estimate}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$TEST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_TEST_cor[i] <- data_w1$TEST_cor[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$TEST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_TEST_cor[i] <- data_w2$TEST_cor[i] - mean(comp_values, na.rm = TRUE)
}
```  

```{r Grade DTW - EST basal estimate}
# Wave 1:
for (i in 1:nrow(data_w1)) { 
  comp_values <- data.frame()
  curr_grade <- data_w1$grade[i]
  temp_data_w1 <- data_w1[-i, ] 
  
  for (j in 1:nrow(temp_data_w1)) {
    curr_comp_values <- ifelse(temp_data_w1$grade[j] == curr_grade, temp_data_w1$EST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w1$gradewindow_EST_cor[i] <- data_w1$EST_cor[i] - mean(comp_values, na.rm = TRUE)
}

# Wave 2:
for (i in 1:nrow(data_w2)) { 
  comp_values <- data.frame()
  curr_grade <- data_w2$grade[i]
  temp_data_w2 <- data_w2[-i, ] 
  
  for (j in 1:nrow(temp_data_w2)) {
    curr_comp_values <- ifelse(temp_data_w2$grade[j] == curr_grade, temp_data_w2$EST_cor[j], NA)
    comp_values <- c(comp_values, curr_comp_values)
  }
  comp_values <- as.numeric(comp_values)
  data_w2$gradewindow_EST_cor[i] <- data_w2$EST_cor[i] - mean(comp_values, na.rm = TRUE)
}
```      


```{r resid/window correlations}
# correlate each residual measure with the dynamic timing window (DTW) measure:
library(Hmisc)
library(corrplot)

# wave 1:
w1_all <- select (data_w1, "resid_ldstage", "window_ldstage", "resid_pdsstage", "window_pdsstage", "resid_ADRENcomp", "window_ADRENcomp", "resid_GONADcomp", "window_GONADcomp", "resid_PUBcomp", "window_PUBcomp", "resid_parent_pdsstage", "window_parent_pdsstage", "resid_DHEAmean", "window_DHEAmean", "resid_TESTmean", "window_TESTmean", "resid_ESTmean", "window_ESTmean", "resid_DHEA_cor", "window_DHEA_cor", "resid_TEST_cor", "window_TEST_cor", "resid_EST_cor", "window_EST_cor", "gradewindow_ldstage", "gradewindow_pdsstage", "gradewindow_ADRENcomp", "gradewindow_GONADcomp", "gradewindow_PUBcomp", "gradewindow_parent_pdsstage", "gradewindow_DHEAmean", "gradewindow_TESTmean", "gradewindow_ESTmean", "gradewindow_DHEA_cor", "gradewindow_TEST_cor", "gradewindow_EST_cor")

library(moments)
skewness(w1_all, na.rm = TRUE)
kurtosis(w1_all, na.rm = TRUE)
#skewness is ok, kurtosis technically a little high, tried pearson first but then looked at spearman and kendall)

# First for AGE windows (6 months) - age resid vs age windows:
corr_w1_r <- cor(w1_all, use="pairwise.complete.obs", method="pearson")
corr_w1_rho <- cor(w1_all, use="pairwise.complete.obs", method="spearman")
corr_w1_tau <- cor(w1_all, use="pairwise.complete.obs", method="kendall")

corr_w1_rbar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_r=c(corr_w1_r[1,2], corr_w1_r[3,4], corr_w1_r[5,6], corr_w1_r[7,8], corr_w1_r[9,10], corr_w1_r[11,12], corr_w1_r[13,14], corr_w1_r[15,16], corr_w1_r[17,18], corr_w1_r[19,20], corr_w1_r[21,22], corr_w1_r[23,24]))

corr_w1_rhobar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_rho=c(corr_w1_rho[1,2], corr_w1_rho[3,4], corr_w1_rho[5,6], corr_w1_rho[7,8], corr_w1_rho[9,10], corr_w1_rho[11,12], corr_w1_rho[13,14], corr_w1_rho[15,16], corr_w1_rho[17,18], corr_w1_rho[19,20], corr_w1_rho[21,22], corr_w1_rho[23,24]))

corr_w1_taubar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_tau=c(corr_w1_tau[1,2], corr_w1_tau[3,4], corr_w1_tau[5,6], corr_w1_tau[7,8], corr_w1_tau[9,10], corr_w1_tau[11,12], corr_w1_tau[13,14], corr_w1_tau[15,16], corr_w1_tau[17,18], corr_w1_tau[19,20], corr_w1_tau[21,22], corr_w1_tau[23,24]))
library(ggplot2)
library(viridis)

w1_plot <- ggplot(data=corr_w1_rbar, aes(x=timing_measure, y=resid_window_r, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_r, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w1_rbar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W1 Pearson corr of age residual & 6 mo dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (r)") + 
  ylim(0,1)

w1_rho_plot <- ggplot(data=corr_w1_rhobar, aes(x=timing_measure, y=resid_window_rho, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_rho, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w1_rhobar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W1 Spearman corr of age residual & 6 mo dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (rho)") +
  ylim(0,1)

w1_tau_plot <- ggplot(data=corr_w1_taubar, aes(x=timing_measure, y=resid_window_tau, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_tau, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w1_taubar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W1 Kendall corr of age residual & 6 mo dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (tau)") +
  ylim(0,1)

# Then for GRADE windows (pearson only) - age resid vs grade windows:
corr_w1_rbar_grade <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_r_grade=c(corr_w1_r[1,25], corr_w1_r[3,26], corr_w1_r[5,27], corr_w1_r[7,28], corr_w1_r[9,29], corr_w1_r[11,30], corr_w1_r[13,31], corr_w1_r[15,32], corr_w1_r[17,33], corr_w1_r[19,34], corr_w1_r[21,35], corr_w1_r[23,36]))
w1_plot_grade <- ggplot(data=corr_w1_rbar_grade, aes(x=timing_measure, y=resid_window_r_grade, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_r_grade, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w1_rbar_grade$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W1 Pearson corr of age residual & GRADE dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (r)")

# Then for GRADE vs. age windows (no residuals) - pearson only:
corr_w1_rbar_windows <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), age_grade_window_r=c(corr_w1_r[2,25], corr_w1_r[4,26], corr_w1_r[6,27], corr_w1_r[8,28], corr_w1_r[10,29], corr_w1_r[12,30], corr_w1_r[14,31], corr_w1_r[16,32], corr_w1_r[18,33], corr_w1_r[20,34], corr_w1_r[22,35], corr_w1_r[24,36]))

w1_plot_windows <- ggplot(data=corr_w1_rbar_windows, aes(x=timing_measure, y=age_grade_window_r, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(age_grade_window_r, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w1_rbar_windows$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W1 Pearson corr of AGE (6 mo) vs. GRADE dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (r)")


corr_w1_rcorr <- rcorr(as.matrix(w1_all)) # for saving later
library(ggcorrplot)
w1_corrmat <- ggcorrplot(corr_w1_r) + 
  scale_fill_viridis(discrete = FALSE) +
  labs(title = "W1 Pearson corrs of timing (incl. age residual & DTW)")

# wave 2:
w2_all <- select (data_w2, "resid_ldstage", "window_ldstage", "resid_pdsstage", "window_pdsstage", "resid_ADRENcomp", "window_ADRENcomp", "resid_GONADcomp", "window_GONADcomp", "resid_PUBcomp", "window_PUBcomp", "resid_parent_pdsstage", "window_parent_pdsstage", "resid_DHEAmean", "window_DHEAmean", "resid_TESTmean", "window_TESTmean", "resid_ESTmean", "window_ESTmean", "resid_DHEA_cor", "window_DHEA_cor", "resid_TEST_cor", "window_TEST_cor", "resid_EST_cor", "window_EST_cor", "gradewindow_ldstage", "gradewindow_pdsstage", "gradewindow_ADRENcomp", "gradewindow_GONADcomp", "gradewindow_PUBcomp", "gradewindow_parent_pdsstage", "gradewindow_DHEAmean", "gradewindow_TESTmean", "gradewindow_ESTmean", "gradewindow_DHEA_cor", "gradewindow_TEST_cor", "gradewindow_EST_cor")
skewness(w2_all, na.rm = TRUE)
kurtosis(w2_all, na.rm = TRUE)
#skewness is ok, kurtosis technically a little high, could use method="spearman" for rho if wanted)
corr_w2_r <- cor(w2_all, use="pairwise.complete.obs", method="pearson")
corr_w2_rho <- cor(w2_all, use="pairwise.complete.obs", method="spearman")
corr_w2_tau <- cor(w2_all, use="pairwise.complete.obs", method="kendall")

# First for AGE Windows - age resid vs age DTWs
corr_w2_rbar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_r=c(corr_w2_r[1,2], corr_w2_r[3,4], corr_w2_r[5,6], corr_w2_r[7,8], corr_w2_r[9,10], corr_w2_r[11,12], corr_w2_r[13,14], corr_w2_r[15,16], corr_w2_r[17,18], corr_w2_r[19,20], corr_w2_r[21,22], corr_w2_r[23,24]))

corr_w2_rhobar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_rho=c(corr_w2_rho[1,2], corr_w2_rho[3,4], corr_w2_rho[5,6], corr_w2_rho[7,8], corr_w2_rho[9,10], corr_w2_rho[11,12], corr_w2_rho[13,14], corr_w2_rho[15,16], corr_w2_rho[17,18], corr_w2_rho[19,20], corr_w2_rho[21,22], corr_w2_rho[23,24]))

corr_w2_taubar <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_tau=c(corr_w2_tau[1,2], corr_w2_tau[3,4], corr_w2_tau[5,6], corr_w2_tau[7,8], corr_w2_tau[9,10], corr_w2_tau[11,12], corr_w2_tau[13,14], corr_w2_tau[15,16], corr_w2_tau[17,18], corr_w2_tau[19,20], corr_w2_tau[21,22], corr_w2_tau[23,24]))

w2_plot <- ggplot(data=corr_w2_rbar, aes(x=timing_measure, y=resid_window_r, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_r, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w2_rbar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W2 Pearson corrs of age residual & 6 mo dynamic timing windows", x ="Wave 2 measure of timing", y = "correlation (r)") + 
  ylim(0,1)

w2_rho_plot <- ggplot(data=corr_w2_rhobar, aes(x=timing_measure, y=resid_window_rho, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_rho, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w2_rhobar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="w2 Spearman corr of age residual & 6 mo dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (rho)") +
  ylim(0,1)

w2_tau_plot <- ggplot(data=corr_w2_taubar, aes(x=timing_measure, y=resid_window_tau, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_tau, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w2_taubar$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="w2 Kendall corr of age residual & 6 mo dynamic timing windows", x ="Wave 1 measure of timing", y = "correlation (tau)") +
  ylim(0,1)

# Then for GRADE windows - age resid vs grade windows (pearson only):
corr_w2_rbar_grade <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), resid_window_r_grade=c(corr_w2_r[1,25], corr_w2_r[3,26], corr_w2_r[5,27], corr_w2_r[7,28], corr_w2_r[9,29], corr_w2_r[11,30], corr_w2_r[13,31], corr_w2_r[15,32], corr_w2_r[17,33], corr_w2_r[19,34], corr_w2_r[21,35], corr_w2_r[23,36]))

w2_plot_grade <- ggplot(data=corr_w2_rbar_grade, aes(x=timing_measure, y=resid_window_r_grade, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(resid_window_r_grade, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w2_rbar_grade$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="W2 Pearson corr of age residual & GRADE dynamic timing windows", x ="Wave 2 measure of timing", y = "correlation (r)")

# Then for GRADE vs. age windows (no residuals):
corr_w2_rbar_windows <- data.frame(timing_measure=c("ldstage", "pdsstage", "ADRENcomp", "GONADcomp", "PUBcomp", "parent_pdsstage", "DHEAmean", "TESTmean", "ESTmean", "DHEA_cor", "TEST_cor", "EST_cor"), age_grade_window_r=c(corr_w2_r[2,25], corr_w2_r[4,26], corr_w2_r[6,27], corr_w2_r[8,28], corr_w2_r[10,29], corr_w2_r[12,30], corr_w2_r[14,31], corr_w2_r[16,32], corr_w2_r[18,33], corr_w2_r[20,34], corr_w2_r[22,35], corr_w2_r[24,36]))

w2_plot_windows <- ggplot(data=corr_w2_rbar_windows, aes(x=timing_measure, y=age_grade_window_r, fill=timing_measure)) +
  geom_bar(stat="identity") +
  geom_text(aes(label=round(age_grade_window_r, digits=2)), vjust=-0.5, color="black", size=3) +
  scale_x_discrete(limits=corr_w2_rbar_windows$timing_measure) +
  scale_fill_viridis(discrete=TRUE) +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1), legend.position = "none") +
  labs(title="w2 Pearson corr of AGE (6 mo) vs. GRADE dynamic timing windows", x ="Wave 2 measure of timing", y = "correlation (r)")

corr_w2_rcorr <- rcorr(as.matrix(w2_all)) # for saving later
w2_corrmat <- ggcorrplot(corr_w2_r) + 
  scale_fill_viridis(discrete = FALSE) +
  labs(title = "W2 Pearson corrs of timing (incl. age residual & DTW)")

# Going back to resid vs age windows, what are the correlations between the correlations W1 vs W2
corr_w1w2 <- merge(corr_w1_rbar, corr_w2_rbar, by = "timing_measure")
corr_w1w2$adr_gon <- c("ADR", "ADR", "ADR", "GON", "GON", "GON", "PUB", "PUB", "PUB", "PUB", "ADR", "ADR")
W1_W2_corr_corrs <- ggplot(corr_w1w2, aes(x = resid_window_r.x, y = resid_window_r.y)) + 
  geom_point(size = 5, aes(colour = factor(adr_gon))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_smooth(method=lm) +
  geom_text(aes(label=timing_measure, hjust=0, vjust=0, size = 1)) +
  labs(title="W1 vs W2 Pearson correlations (residual and window)", x ="W1 correlation", y = "W2 correlation") 

corr_w1w2_rho <- merge(corr_w1_rhobar, corr_w2_rhobar, by = "timing_measure")
corr_w1w2_rho$adr_gon <- c("ADR", "ADR", "ADR", "GON", "GON", "GON", "PUB", "PUB", "PUB", "PUB", "ADR", "ADR")
W1_W2_corr_corrs_rho <- ggplot(corr_w1w2_rho, aes(x = resid_window_rho.x, y = resid_window_rho.y)) + 
  geom_point(size = 5, aes(colour = factor(adr_gon))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_smooth(method=lm) +
  geom_text(aes(label=timing_measure, hjust=0, vjust=0, size = 1)) +
  labs(title="W1 vs W2 Spearman correlations (residual and window)", x ="W1 correlation", y = "W2 correlation")

corr_w1w2_tau <- merge(corr_w1_taubar, corr_w2_taubar, by = "timing_measure")
corr_w1w2_tau$adr_gon <- c("ADR", "ADR", "ADR", "GON", "GON", "GON", "PUB", "PUB", "PUB", "PUB", "ADR", "ADR")
W1_W2_corr_corrs_tau <- ggplot(corr_w1w2_tau, aes(x = resid_window_tau.x, y = resid_window_tau.y)) + 
  geom_point(size = 5, aes(colour = factor(adr_gon))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_smooth(method=lm) +
  geom_text(aes(label=timing_measure, hjust=0, vjust=0, size = 1)) +
  labs(title="W1 vs W2 Kendall correlations (residual and window)", x ="W1 correlation", y = "W2 correlation")

library(cowplot)
w1w2_ageage_plots <- plot_grid(w1_plot, w2_plot, labels = "AUTO")
w1w2_agegrade_plots <- plot_grid(w1_plot_grade, w2_plot_grade, labels = "AUTO")
w1w1_agegrade_plots <- plot_grid(w1_plot, w1_plot_grade, labels = "AUTO")
w2w2_agegrade_plots <- plot_grid(w2_plot, w2_plot_grade, labels = "AUTO")
w1w2_windows_plots <- plot_grid(w1_plot_windows, w2_plot_windows, labels = "AUTO")

w1_r_rho_tau_plots <- plot_grid(w1_plot, w1_rho_plot, w1_tau_plot)
w2_r_rho_tau_plots <- plot_grid(w2_plot, w2_rho_plot, w2_tau_plot)

##### DEEPER LOOK INTO WEAKER CORRELATIONS ##### 

#Some W2 correlations (resid vs. windows, either kind of window) are terrible, so take a look what's going on. Grade vs. age windows are very similar so we'll just examine age residuals vs. age windows.

# Maybe it's the younger/older girls causing problems? Label age and ID on points.
mean(data_w2$age, na.rm = TRUE)
# Example of worst correlation - check PDS stage as the factor:
w2_TESTcor_sct_pdsstage <- ggplot(data_w2, aes(x = resid_TEST_cor, y = window_TEST_cor)) + 
  geom_point(size = 3.5, aes(colour = factor(pdsstage))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_text(aes(label=paste(tagid, "(",round(age, digits=2),")")),hjust=0, vjust=0, size = 3)

# Check ADRENcomp factor:
w2_TESTcor_sct_ADRENcomp <- ggplot(data_w2, aes(x = resid_TEST_cor, y = window_TEST_cor)) + 
  geom_point(size = 3.5, aes(colour = factor(ADRENcomp))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_text(aes(label=paste(tagid, "(",round(age, digits=2),")")),hjust=0, vjust=0, size = 3)

# Check the number of comparable N in the DTWs
w2_TESTcor_sct_compNs <- ggplot(data_w2, aes(x = resid_TEST_cor, y = window_TEST_cor)) + 
  geom_point(size = 3.5, aes(colour = factor(window_TEST_cor_compN))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_text(aes(label=paste(tagid, "(",window_TEST_cor_compN,")")),hjust=0, vjust=0, size = 3) +
  geom_smooth(method=lm)

#Check ADRENcomp on its own:
w2_ADRENcomp_sct <- ggplot(data_w2, aes(x = resid_ADRENcomp, y = window_ADRENcomp)) + 
  geom_point(size = 3.5) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_text(aes(label=paste(tagid, "(",round(age, digits=2),")")),hjust=0, vjust=0, size = 3)

# Example of tightest correlation:
w2_ESTcor_scatter <- ggplot(data_w2, aes(x = resid_EST_cor, y = window_EST_cor)) + 
  geom_point(size = 3.5, aes(colour = factor(pdsstage))) +
  scale_color_viridis(discrete=TRUE) +
  theme_bw() +
  geom_text(aes(label=paste(tagid, "(",round(age, digits=2),")")),hjust=0, vjust=0, size = 3)
```


```{r export}
data <- rbind(data_w1, data_w2)

library(xlsx) 
write.xlsx(corr_w1$r, file.path(workdir,"projects/W1_W2_pubertal_timing/residual_window_corr.xlsx", fsep=""), sheetName="w1_r", row.names=FALSE) 

write.xlsx(corr_w1$P, file.path(workdir,"projects/W1_W2_pubertal_timing/residual_window_corr.xlsx", fsep=""), sheetName="w1_p", append=TRUE, row.names=FALSE)

write.xlsx(corr_w2$r, file.path(workdir,"projects/W1_W2_pubertal_timing/residual_window_corr.xlsx", fsep=""), sheetName="w2_r", append=TRUE, row.names=FALSE) 

write.xlsx(corr_w2$P, file.path(workdir,"projects/W1_W2_pubertal_timing/residual_window_corr.xlsx", fsep=""), sheetName="w2_p", append=TRUE, row.names=FALSE)

# save DTWs with the other variables as a separate file because we probably won't continue to use DTW in further analyses. UPDATE: OR WILL WE?? Corrs are kinda crap at W2...
write.csv(data,file.path(workdir,"projects/W1_W2_pubertal_timing/Dynamic_timing_windows.csv", fsep=""), row.names = FALSE)
```