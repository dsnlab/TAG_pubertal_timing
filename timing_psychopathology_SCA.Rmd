---
title: "W1 W2 pubertal timing psychopathology SCA"
author: "Michelle Byrne"
date: "3/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set Working Directory
```{r Set Directory, message=FALSE, warning=FALSE, include=FALSE}
getwd()
#You should set this to the TAG directory on the CAS file server 
workdir='Y:/dsnlab/TAG/' 
```

```{r Load Data}
require(dplyr)
require(zoo)
library(lme4)
# Load Data (Wave 1 and 2) first - see Marjolein's code for how this all got put together
data <- read.csv(file.path(workdir,"resid_projects/W1_W2_pubertal_timing/Timing_and_Internalizing.csv", fsep=""))


```

# Model decisions and setup:

# 2 timepoints x N pubertal timing variables x N internalising outcome variables x control variables Y/N (OR possible combinations of N control variables) x impute or not = N models
```{r setup}
require(specr)
require (tidyverse)

# UPDATE BELOW WITH PRE/POST IMPUTATION !!
# RECODE SUBJ TIMING VARS SO HIGHER = EARLIER, OR RESID VARS SO THAT HIGHER = LATER !!
            
# Split into two SCA's: one with continuous outcomes, one with binary outcomes, then combine rows before plotting

setup_specs(y = c("CESDC_total_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("lm"),           # linear model
            controls = c("Parent_ed_wave1", "CESDC_total_wave1"))  # control variables 

setup_specs(y = c("SCARED_mean_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("lm"),           # linear model
            controls = c("Parent_ed_wave1", "SCARED_mean_wave1"))  # control variables 
 
setup_specs(y = c("depres_d_wave2"), #,"resid_anx_d_wave2","resid_int_d_wave2","resid_distress_d_wave2","resid_fear_d_wave2"
            x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),
            model = c("logistic"),           
            controls = c("Parent_ed_wave1", "depres_d_wave1"))  

```


# The main function is run_specs() in which analytical choices are specified as arguments. The function plot_specs() can then be used to visualize the results.

# The function runs traditional linear regression models by default (i.e. when model = "lm" is provided as argument). However, customized model functions can be passed to the function, too.
```{r run_sca}
# !! - UPDATE BELOW WITH PRE/POST IMPUTATION 
# Split into two SCA's: one with continuous outcomes, one with binary outcomes, then combine rows before plotting

results_cesdc <- run_specs(df = data, 
                     y = c("CESDC_total_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("lm"),           # linear model
            controls = c("Parent_ed_wave1", "CESDC_total_wave1"))  # control variables 

results_scared <- run_specs(df = data, 
                  y = c("SCARED_mean_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("lm"),           # linear model
            controls = c("Parent_ed_wave1", "SCARED_mean_wave1"))  # control variables 

 logistic <- function(formula, data) {
  glm(formula = formula, 
      data = data, 
      family = binomial)}
 
results_deprd <- run_specs(df = data, 
                     y = c("depres_d_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("logistic"),           # linear model
            controls = c("Parent_ed_wave1", "depres_d_wave1"))  # control variables 

results_anxd <- run_specs(df = data, 
                     y = c("anx_d_wave2"),     #dependent variables
              x = c("aam_final","subj_timing_wave1","parent_subj_timing_wave1","resid_im_ldstage_wave1","resid_im_pdsstage_wave1","resid_im_ADRENcomp_wave1","resid_im_GONADcomp_wave1","resid_im_PUBcomp_wave1","resid_im_DHEAmean_wave1","resid_im_TESTmean_wave1","resid_im_ESTmean_wave1","resid_im_DHEA_cor_wave1","resid_im_TEST_cor_wave1","resid_im_EST_cor_wave1","subj_timing_wave2","parent_subj_timing_wave2","resid_im_ldstage_wave2","resid_im_pdsstage_wave2","resid_im_ADRENcomp_wave2","resid_im_GONADcomp_wave2","resid_im_PUBcomp_wave2","resid_im_DHEAmean_wave2","resid_im_TESTmean_wave2","resid_im_ESTmean_wave2","resid_im_DHEA_cor_wave2","resid_im_TEST_cor_wave2","resid_im_EST_cor_wave2"),       #independent variables
            model = c("logistic"),           # linear model
            controls = c("Parent_ed_wave1", "anx_d_wave1"))  # control variables 

#stack results
results <- rbind(results_cesdc,results_deprd,results_scared,results_anxd)


```

```{r visualise}
# We can now plot a simple decision tree to understand how our analytical choices lead to a large number of specifications:

plot_decisiontree(results, 
                  legend = TRUE)

# basic summary of the entire specification curve:
summarise_specs(results)

# summary by specific groups and  statistics:
summarise_specs(results,                         # result data frame
                x, y,                            # grouping variables
                stats = lst(median, min, max))   # specific functions

# Plot specification curve analysis:
plot_specs(results, choices = c("x", "y", "controls", "subsets"))

#to produce respective boxplots:
plot_summary(results)
```

# Decompose the variance in the specification curve

#Finally, we can estimate how much variance in the specification curve is related to which analytical decisions. Therefore, we have to estimate a basic multilevel model without predictors and the analytical decisions as random effects (interactions could be included too). We then use the function icc_specs() to calculate a respective table or plot_variance() to visualize the distribution.
```{r}
# Estimate multilevel model 

model <- lmer(estimate ~ 1 + (1|x)  + (1|y) +  (1|model) , data = results)

# Get intra-class correlation
icc_specs(model) %>%
  mutate_if(is.numeric, round, 2)

# Plot decomposition
plot_variance(model)

# Customize plots instructions:
# https://masurp.github.io/specr/articles/custom-plot.html
```

