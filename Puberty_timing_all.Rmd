---
title: "Pubertaltiming_alltheways"
output: html_document
---

```{r setup, include=FALSE}
packages <- c("lme4" , "ggplot2","tidyr","dplyr", "psych","ggcorrplot","mice","BaylorEdPsych","readxl")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}
lapply(packages, library, character.only = TRUE)

cas_dir="Y:/dsnlab/TAG/"
```

```{r Combine all puberty measures in long format, include=FALSE}

#PDS, LD, and composite measures
PubertyComposite <- read.table(paste0(cas_dir,'behavior/Questionnaires/Puberty/Allwaves_PubertyComposite.csv'),header=T,sep=",") %>%
  filter(wave<3) %>% select(-age) %>%
  dplyr::rename(pdsstage=pdss, ldstage=stage)

#replace age with most complete data
Age <- read.csv(paste0(cas_dir,'behavior/Demographics/Age/TAG_age.csv'),header=T,sep=",") %>% 
        filter(wave<3) %>% filter(session==2) %>% 
        select(tagid,wave,age_excel) %>%
        dplyr::rename(age=age_excel)

#Get PDS_F5(subjective timing) all waves 
file_list_cpds = Sys.glob(paste0(cas_dir, 'behavior/Questionnaires/Wave*/PDS_Wave*.csv'))
ChildPDS = data.frame()
for (file in file_list_cpds) {
  temp <- read.table(file, header=TRUE, sep=",") %>%
    select(tagid, PDS_F1, PDS_F2, PDS_F3, PDS_F4, PDS_F5, PDS_F6, pdss) %>%
    mutate(wave = regmatches(file, regexpr("[[:digit:]]+", file)))
  ChildPDS = rbind(ChildPDS, temp)
  rm(temp) }
ChildPDS <- ChildPDS %>%
#  mutate(menarchescore=ifelse(PDS_F6==1,4,ifelse(PDS_F6==0,1,NA))) %>%
  dplyr::rename(subj_timing=PDS_F5)
#ChildPDS$pdsscore <- rowMeans(ChildPDS[,c("PDS_F1","PDS_F2","PDS_F3","PDS_F4","menarchescore")], na.rm=TRUE)

#Get parent pds 
#Note that Parent PDS is missing for half of pp at wave 1
file_list_ppds = Sys.glob(paste0(cas_dir, 'behavior/Questionnaires/Wave*/PDS_parent_Wave*.csv'))

ParentPDS = data.frame()
for (file in file_list_ppds) {
  temp <- read.table(file, header=TRUE, sep=",") %>%
    select(tagid, PDS_F1, PDS_F2, PDS_F3, PDS_F4, PDS_F5, PDS_F6, pdss) %>%
    mutate(wave = regmatches(file, regexpr("[[:digit:]]+", file)))
  ParentPDS = rbind(ParentPDS, temp)
  rm(temp) }

ParentPDS <- ParentPDS %>% 
  dplyr::rename(parent_pdsstage=pdss, parent_subj_timing=PDS_F5)  
#  mutate(menarchescore=ifelse(PDS_F6==1,4,ifelse(PDS_F6==0,1,NA)))
#ParentPDS$parent_pdsscore <- rowMeans(ParentPDS[,c("PDS_F1","PDS_F2","PDS_F3","PDS_F4","menarchescore")], na.rm=TRUE)

#merge all the measures in one dataframe
Puberty_all <- merge(PubertyComposite[,c("tagid","wave","pdsstage","ldstage","ADRENcomp","GONADcomp","PUBcomp")], ChildPDS[,c("tagid","wave","subj_timing")], by=c("tagid","wave"),all=T)
Puberty_all <- merge(Puberty_all, ParentPDS[,c("tagid","wave", "parent_pdsstage","parent_subj_timing")], by=c("tagid","wave"),all=T)
Puberty_all <- merge(Puberty_all, Age, by=c("tagid","wave"),all=T)

#Only wave 1 and 2
Puberty_allways <- Puberty_all %>% filter(wave<3)

#Add hormones
Hormones <- read.table(paste0(cas_dir,'behavior/Puberty/Saliva//TAG_W1W2_Saliva_basalestimates.csv'), header=T, sep=",") %>% 
  select(SID,DHEAmean_wave1,TESTmean_wave1,ESTmean_wave1,DHEAmean_wave2,TESTmean_wave2,ESTmean_wave2,DHEAcoef_imp_wave1,TESTcoef_imp_wave1,ESTcoef_imp_wave1,DHEAcoef_imp_wave2,TESTcoef_imp_wave2,ESTcoef_imp_wave2) %>%
  mutate(tagid=sprintf("TAG%03d", SID)) %>% select(-SID) %>%
  pivot_longer(cols=contains("wave"),names_to = c(".value","wave"), names_pattern = "(.*)_wave(.*)") %>%
  rename(DHEA_cor=DHEAcoef_imp,TEST_cor=TESTcoef_imp,EST_cor=ESTcoef_imp)

Puberty_allways <- merge(Puberty_allways,Hormones,by=c("tagid","wave"),all=T)

#Filter out excluded participants
overview <- read_excel(paste0(cas_dir,'behavior/Overview/Overview_Withdrawn_Completed/TAG_Overview_Doc.xlsx'),sheet=1)
overview <- overview[,c("TAG_ID","W1S2_Completed","Withdrawn_W1","Exclusionary_Withdrawl")]
overview <- overview %>% 
  rename(tagid = TAG_ID) %>%
  replace_na(list(Withdrawn_W1 = 0)) %>%
  replace_na(list(Exclusionary_Withdrawl = 0)) %>% 
  arrange(Exclusionary_Withdrawl) %>% 
  filter(Exclusionary_Withdrawl==0) %>%
  filter(Withdrawn_W1==0)
Puberty_allways <- Puberty_allways %>% filter(tagid %in% overview$tagid)

```

```{r checks on parent pds}

# First check missing data percentages:
Puberty_allways

# Next, for the W1 parent_PDSstage, which is the only variable assumed missing not at random (because we introduced it at W1 halfway through, and we recruited older girls first), check if any observed vars at W1 are associated with whether or not they were given the parent PDS (0 = not given, 1 = given).
have_parPDS <- read.csv(file.path(cas_dir,"projects/W1_W2_pubertal_timing/before_after_parentPDSw1.csv", fsep=""))
parPDScompare <- merge(Puberty_allways, have_parPDS, by = c("tagid", "wave"), all=T)
w1_parPDScompare <- parPDScompare[which(parPDScompare$wave=='1'),]

# Compare each stage variable. I've marked stats if significantly different.
age_parPDScompare <- t.test(w1_parPDScompare$age ~ w1_parPDScompare$before_after_parentPDSw1) #t = 4.1773, df = 146.94, p-value = 5.038e-05, mean in group 0 = 11.88904, mean in group 1 = 11.38687
pdsstage_parPDScompare <- t.test(w1_parPDScompare$pdsstage ~ w1_parPDScompare$before_after_parentPDSw1)

ldstage_parPDScompare <- t.test(w1_parPDScompare$ldstage ~ w1_parPDScompare$before_after_parentPDSw1) # t = 3.2182, df = 150.88, p-value = 0.001579, mean in group 0 = 3.056962, mean in group 1 = 2.594595

ADRENcomp_parPDScompare <- t.test(w1_parPDScompare$ADRENcomp ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.0515, df = 159.93, p-value = 0.04185, mean in group 0 = 3.033708, mean in group 1 = 2.693333

GONADcomp_parPDScompare <- t.test(w1_parPDScompare$GONADcomp ~ w1_parPDScompare$before_after_parentPDSw1) # t = 3.1169, df = 158.52, p-value = 0.002171, mean in group 0 = 3.155172, mean in group 1 = 2.723684

PUBcomp_parPDScompare <- t.test(w1_parPDScompare$PUBcomp ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.8039, df = 158.76, p-value = 0.005679, mean in group 0 = 3.089080, mean in group 1 = 2.703333

subj_timing_parPDScompare <- t.test(w1_parPDScompare$subj_timing ~ w1_parPDScompare$before_after_parentPDSw1)

DHEAmean_parPDScompare <- t.test(w1_parPDScompare$DHEAmean ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.0943, df = 164.36, p-value = 0.03776, mean in group 0 = 4.324467, mean in group 1 = 4.015990

TESTmean_parPDScompare <- t.test(w1_parPDScompare$TESTmean ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.8086, df = 160.94, p-value = 0.005592, mean in group 0 = 3.752465, mean in group 1 = 3.576161

ESTmean_parPDScompare <- t.test(w1_parPDScompare$ESTmean ~ w1_parPDScompare$before_after_parentPDSw1) # t = 4.0321, df = 163.14, p-value = 8.469e-05, mean in group 0 = 1.608754, mean in group 1 = 1.556002

DHEA_cor_parPDScompare <- t.test(w1_parPDScompare$DHEA_cor ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.1072, df = 164.35, p-value = 0.03662, mean in group 0 = 4.329900, mean in group 1 = 4.035578

TEST_cor_parPDScompare <- t.test(w1_parPDScompare$TEST_cor ~ w1_parPDScompare$before_after_parentPDSw1) # t = 2.7963, df = 161.9, p-value = 0.005796, mean in group 0 = 3.769135, mean in group 1 = 3.614615

EST_cor_parPDScompare <- t.test(w1_parPDScompare$EST_cor ~ w1_parPDScompare$before_after_parentPDSw1) # t = 3.9926, df = 162.86, p-value = 9.868e-05, mean in group 0 = 1.604741, mean in group 1 = 1.559396

```

```{r combine puberty variables with mh variables and covariates}

#remove duplicates (TAG077 and TAG124 wave 2)
Puberty_allways <- Puberty_allways[!duplicated(Puberty_allways[c("tagid","wave")]),]
#load mh variables
Internalizing_all <- read.csv(paste0(cas_dir,"projects/W1_W2_pubertal_timing/Internalizing_allways.csv"),header=T,sep=",")
Internalizing_all_long <- pivot_longer(Internalizing_all,cols=contains("w"),names_to = c(".value","wave"), names_pattern = "(.*)_w(.*)")
#merge
all_for_imp <- merge(Puberty_allways,Internalizing_all_long,by=c("tagid","wave"))
#covariates
CTQ <- read.csv(paste0(cas_dir,"projects/W1_W2_pubertal_timing/W1_CTQ_threatscoring.csv")) 
CTQ <- CTQ %>% 
  rename(CTQ_threat=CTQ_threat_total_75perc) %>% 
  mutate(tagid=sprintf("TAG%03d", SID))
all_for_imp <- all_for_imp %>% merge(.,have_parPDS,by=c("tagid","wave"),all.x=T) %>%
                              merge(.,CTQ[,c("tagid","CTQ_threat")],by=c("tagid"),all.x=T)

```

```{r imputation}

#Note: we're not imputing age at menarche (added below) because missings are mostly pre-menarcheal girls (=MNAR)

#check missingness pattern
md.pattern(all_for_imp)

all_for_imp$const <- 1
all_for_imp$PP <- as.integer(all_for_imp$tagid)
all_for_imp <- all_for_imp %>% 
    mutate(depres_d=as.factor(depres_d),anx_d=as.factor(anx_d),int_d=as.factor(int_d),distress_d=as.factor(distress_d),fear_d=as.factor(fear_d),before_after_parentPDSw1=as.factor(before_after_parentPDSw1))
#impute
ini <- mice(all_for_imp, maxit=0, print=F)
meth <- ini$meth
meth["PUBcomp"]<- "~ I((ADRENcomp + GONADcomp) / 2)" #tell mice that PUBcomp is calculated from ADREN and GONAD
meth[which(meth == "pmm")] <- "2l.norm" #2-level data with heterogeneous within pp variance
meth[c("depres_d","anx_d","int_d","distress_d","fear_d")] <- "logreg"
meth["CTQ_threat"] <- "2lonly.norm"
pred<- quickpred(all_for_imp,method="spearman",exclude= 'tagid') # exclude tagid
pred[c("GONADcomp", "ADRENcomp"), "PUBcomp"] <- 0 # avoid circular prediction from PUBcomp
pred[,"PP"]<- -2 # set ID as class variable for 2l.norm
pred[,"const"]<- 2 # random intercept
pred["wave",]<- 0
pred[,"wave"]<- 0
post <- ini$post
post[c("subj_timing","parent_subj_timing","ldstage","pdsstage","parent_pdsstage","ADRENcomp","GONADcomp","PUBcomp")] <- "imp[[j]][, i] <- squeeze(imp[[j]][, i], c(1, 5))" #constrain the self-report variables to their range of 1-5
post["SCARED_mean"] <- "imp[[j]][, i] <- squeeze(imp[[j]][, i], c(0, 2))" #constrain the scared
post["CESDC_total"] <- "imp[[j]][, i] <- squeeze(imp[[j]][, i], c(0, 60))" #constrain the cesdc
post["CTQ_threat"] <- "imp[[j]][, i] <- squeeze(imp[[j]][, i], c(0, 68))" #constrain the ctq

imp <- mice(all_for_imp, m=25,maxit=15,meth=meth,pred=pred,post=post,print=FALSE,seed=500)

#Plotting to check the imputations
plot(imp)
miss <- is.na(imp$data$PUBcomp)
xyplot(imp, PUBcomp ~ I ((ADRENcomp + GONADcomp) / 2),
       na.groups = miss,     ylab = "Imputed", xlab = "Calculated")
stripplot(imp, pch = 20, cex = 1.2) 
densityplot(imp) 

#average imputations
completedData <- complete(imp, 'long') %>%   
    select(before_after_parentPDSw1,depres_d,anx_d,int_d,distress_d,fear_d,everything()) %>%
    mutate(depres_d=as.numeric(as.character(depres_d)),anx_d=as.numeric(as.character(anx_d)),int_d=as.numeric(as.character(int_d)),distress_d=as.numeric(as.character(distress_d)),fear_d=as.numeric(as.character(fear_d)))
agg <- aggregate(completedData[,11:28] , by = list(completedData$.id),FUN= mean)
agg2 <- aggregate(completedData[,2:6] , by = list(completedData$.id),FUN= median)
ids <- completedData %>% filter(.imp==1) %>% select(.id,tagid,wave) %>% mutate(Group.1=.id) 
all_im <- agg %>% left_join(.,ids) %>% left_join(.,agg2) %>% select(tagid, wave, everything(), -Group.1,-.id)

#check distribution imputed variables
#put in short format
all_for_imp_short <- all_for_imp %>% pivot_wider(id_cols= tagid, names_from = wave, names_prefix = "wave", values_from = c(age,pdsstage,ldstage,parent_pdsstage,ADRENcomp,GONADcomp,PUBcomp,subj_timing,parent_subj_timing,DHEAmean,DHEA_cor,TESTmean,TEST_cor,ESTmean,EST_cor,SCARED_mean,CESDC_total,depres_d,anx_d,int_d,distress_d,fear_d,CTQ_threat)) 
all_im_short <- all_im %>% pivot_wider(id_cols= tagid, names_from = wave, names_prefix = "im_wave", values_from = c(age,pdsstage,ldstage,parent_pdsstage,ADRENcomp,GONADcomp,PUBcomp,subj_timing,parent_subj_timing,DHEAmean,DHEA_cor,TESTmean,TEST_cor,ESTmean,EST_cor,SCARED_mean,CESDC_total,depres_d,anx_d,int_d,distress_d,fear_d,CTQ_threat)) 
#plot
all_for_imp_short %>% 
  select(-tagid,-depres_d_wave1,-anx_d_wave1,-int_d_wave1,-distress_d_wave1,-fear_d_wave1,-depres_d_wave2,-anx_d_wave2,-int_d_wave2,-distress_d_wave2,-fear_d_wave2) %>% gather() %>%
  ggplot(aes(value)) + facet_wrap(~ key, scales = "free") + geom_histogram()
all_im_short %>% 
  select(-tagid,-depres_d_im_wave1,-anx_d_im_wave1,-int_d_im_wave1,-distress_d_im_wave1,-fear_d_im_wave1,-depres_d_im_wave2,-anx_d_im_wave2,-int_d_im_wave2,-distress_d_im_wave2,-fear_d_im_wave2) %>% gather() %>%
  ggplot(aes(value)) + facet_wrap(~ key, scales = "free") + geom_histogram()

```


Pubertal timing
```{r Pubertal timing from residuals}
#set up timing dataframe
Timing_allways <- all_im_short %>%
  merge(.,all_for_imp_short[,c("tagid","subj_timing_wave1","parent_subj_timing_wave1","SCARED_mean_wave1","CESDC_total_wave1","depres_d_wave1","anx_d_wave1","int_d_wave1","distress_d_wave1","fear_d_wave1","subj_timing_wave2","parent_subj_timing_wave2","SCARED_mean_wave2","CESDC_total_wave2","depres_d_wave2","anx_d_wave2","int_d_wave2","distress_d_wave2","fear_d_wave2","CTQ_threat_wave1")],by="tagid")

#create residuals for each wave separately BEFORE IMPUTATION
pubcolumns1 <- list("ldstage_wave1","pdsstage_wave1","ADRENcomp_wave1","GONADcomp_wave1","PUBcomp_wave1","parent_pdsstage_wave1","DHEAmean_wave1","TESTmean_wave1","ESTmean_wave1","DHEA_cor_wave1","TEST_cor_wave1","EST_cor_wave1")
for(Pub in pubcolumns1){
  modelap1 <- lm(formula = paste(Pub, "~ age_wave1"),data=all_for_imp_short,na.action=na.exclude)
  summary(modelap1)
  Timing_allways[[paste('resid',Pub, sep="_")]] <- resid(modelap1)
}

pubcolumns2 <- c("ldstage_wave2","pdsstage_wave2","ADRENcomp_wave2","GONADcomp_wave2","PUBcomp_wave2","parent_pdsstage_wave2","DHEAmean_wave2","TESTmean_wave2","ESTmean_wave2","DHEA_cor_wave2","TEST_cor_wave2","EST_cor_wave2")
for(Pub in pubcolumns2){
  modelap2 <- lm(formula = paste(Pub, "~ age_wave2"),data=all_for_imp_short,na.action=na.exclude)
  summary(modelap2)
  Timing_allways[[paste('resid',Pub, sep="_")]] <- resid(modelap2)
}

#create residuals for each wave separately AFTER IMPUTATION
pubcolumns1a <- list("ldstage_im_wave1","pdsstage_im_wave1","ADRENcomp_im_wave1","GONADcomp_im_wave1","PUBcomp_im_wave1","DHEAmean_im_wave1","TESTmean_im_wave1","ESTmean_im_wave1","DHEA_cor_im_wave1","TEST_cor_im_wave1","EST_cor_im_wave1")
for(Pub in pubcolumns1a){
  modelap1a <- lm(formula = paste(Pub, "~ age_im_wave1"),data=Timing_allways,na.action=na.exclude)
  summary(modelap1a)
  Timing_allways[[paste('resid',Pub, sep="_")]] <- resid(modelap1a)
}

pubcolumns2a <- c("ldstage_im_wave2","pdsstage_im_wave2","ADRENcomp_im_wave2","GONADcomp_im_wave2","PUBcomp_im_wave2","DHEAmean_im_wave2","TESTmean_im_wave2","ESTmean_im_wave2","DHEA_cor_im_wave2","TEST_cor_im_wave2","EST_cor_im_wave2")
for(Pub in pubcolumns2a){
  modelap2a <- lm(formula = paste(Pub, "~ age_im_wave2"),data=Timing_allways,na.action=na.exclude)
  summary(modelap2a)
  Timing_allways[[paste('resid',Pub, sep="_")]] <- resid(modelap2a)
}

#regression with long format data and create residuals 
#pubcolumns <- c("ldstage","pdsstage","ADRENcomp","GONADcomp","PUBcomp","parent_pdsstage","DHEAmean","TESTmean","ESTmean","DHEA_cor","TEST_cor","EST_cor")
#for(Pub in pubcolumns){
#  modelap1 <- lmer(formula = paste(Pub, "~ age + ( 1 | tagid)"),data=Puberty_allways,na.action=na.exclude)
#  summary(modelap1)
#  Puberty_allways[[paste('resid',Pub, sep="_")]] <- resid(modelap1)
#}


```  

```{r add Age at menarche}

age_at_menarche <- read.csv(paste0(cas_dir,'behavior/Questionnaires/Puberty/Age_at_menarche_short_finalizing.csv'),header=T,sep=",") %>%
  dplyr::select(tagid,aam_final)
Timing_allways <- merge(Timing_allways,age_at_menarche,by="tagid",all=T)


#Adding hormone based timing variables based on the script "Basalestimates_W1W2"
#Hormone_timing <- read.table(paste0(cas_dir,'projects/W1_W2_pubertal_timing/TAG_W1W2_hormonebasedtiming.csv'), header=T, sep=",") %>% 
#  select(SID,DHEAcoef_imp_wave1,TESTcoef_imp_wave1,ESTcoef_imp_wave1,DHEAcoef_imp_wave2,TESTcoef_imp_wave2,ESTcoef_imp_wave2) %>%
#  mutate(tagid=sprintf("TAG%03d", SID))
#Hormone_timing <- Hormone_timing %>% pivot_longer(cols=contains("wave"),names_to = c(".value","wave"), names_pattern = "(.*)_wave(.*)") %>%
#  rename(DHEA_cor_interc=DHEAcoef_imp,TEST_cor_interc=TESTcoef_imp,EST_cor_interc=ESTcoef_imp) %>%
#  select(-SID)
#Timing_allways <- merge(Timing_allways,Hormone_timing,by=c("tagid","wave"),all=T)

```

```{r reorder and correlate all measures}
Timing_allways <- Timing_allways %>% select(age,pdsstage,ldstage,ADRENcomp,GONADcomp,PUBcomp,parent_pdsstage,DHEAmean,TESTmean,ESTmean,DHEA_cor,TEST_cor,EST_cor,subj_timing,parent_subj_timing,everything())

Timing_allwaysn <- select_if(Timing_allways, is.numeric) 
cor_timing_r <- cor(Timing_allwaysn, use="pairwise.complete.obs", method="pearson")
cor_timing_rho <- cor(Timing_allwaysn, use="pairwise.complete.obs", method="spearman")
p_timing_rho <- cor_pmat(Timing_allwaysn)
ggcorrplot(cor_timing_rho, p.mat=p_timing_rho, lab=T, title="Pubertal timing correlations both waves")

Timing_allways1 <- Timing_allways %>% filter(wave<2) 
Timing_allways1 <- select_if(Timing_allways1, is.numeric) 
cor_timing1_r <- cor(Timing_allways1, use="pairwise.complete.obs", method="pearson")
cor_timing1_rho <- cor(Timing_allways1, use="pairwise.complete.obs", method="spearman")
p_timing1_rho <- cor_pmat(Timing_allways1)
ggcorrplot(cor_timing1_rho, p.mat=p_timing1_rho, lab=T, lab_size=3, title="Pubertal timing correlations wave 1")

Timing_allways2 <- Timing_allways %>% filter(wave>1) 
Timing_allways2 <- select_if(Timing_allways2, is.numeric) 
cor_timing2_r <- cor(Timing_allways2, use="pairwise.complete.obs", method="pearson")
cor_timing2_rho <- cor(Timing_allways2, use="pairwise.complete.obs", method="spearman")
p_timing2_rho <- cor_pmat(Timing_allways2)
ggcorrplot(cor_timing2_rho, p.mat=p_timing2_rho, lab=T, lab_size=3, title="Pubertal timing correlations wave 2")

```

``` {r correlate wave 1 with wave 2}
Timing_allways_short <-  dcast(melt(Timing_allways, id.vars=c("tagid", "wave")), tagid~variable+wave)
Timing_allways_shortn <- select_if(Timing_allways_short, is.numeric) 
cor_waves_r <- cor(Timing_allways_shortn, use="pairwise.complete.obs", method="pearson")
cor_waves_rho <- cor(Timing_allways_shortn, use="pairwise.complete.obs", method="spearman")
p_waves_rho <- cor_pmat(Timing_allways_shortn)
ggcorrplot(cor_waves_rho, p.mat=p_waves_rho, lab=T,lab_size=2, title="Pubertal timing correlations between waves")

```


```{r save}
write.csv(Timing_allways,paste0(cas_dir,'projects/W1_W2_pubertal_timing/Timing_and_internalizing.csv'),row.names=F)

# NOTE: Run the dynamic timing window script after this - it calculates timing based on stage of windows of 6 month age peers (and also school grade peers) per person.
```
